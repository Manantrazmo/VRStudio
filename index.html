<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Store Walkthrough â€” VR (thumbstick/WASD)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-extras@7.7.0/dist/aframe-extras.min.js"></script>
    <style>html,body{margin:0;height:100%;background:#2f3033}</style>
  </head>
  <body>
    <a-scene id="scene"
      renderer="antialias:false; physicallyCorrectLights:true; colorManagement:true; shadowMap.enabled:false"
      background="color:#3a3b3f">

      <!-- CHANGE this path to your file if needed -->
      <a-assets timeout="60000">
        <a-asset-item id="room" src="https://ykkuinkyvupwu9iy.public.blob.vercel-storage.com/asset3.glb"></a-asset-item>
      </a-assets>

      <!-- Lighting: simple + fast for headsets -->
      <a-entity light="type: ambient; intensity: 0.8"></a-entity>
      <a-entity id="sun" light="type: directional; intensity: 1.2" position="8 12 6"></a-entity>

      <!-- Light floor so space is never black -->
      <a-plane rotation="-90 0 0" width="600" height="600" color="#a9afb8"></a-plane>

      <!-- Your model -->
      <a-entity id="model" gltf-model="#room"></a-entity>

      <!-- Camera rig: thumbstick/WASD walking + head look -->
      <a-entity id="rig" position="-10 1.6 6" movement-controls kinematic-body="radius:0.3; height:1.6; stepHeight:0.2">
        <a-entity camera look-controls wasd-controls></a-entity>
      </a-entity>

      <!-- Safety: visible until model loads, so you never see black -->
      <a-box id="sanity" position="-10 1.2 3"
             material="color:#ff6a00; emissive:#ff6a00; emissiveIntensity:0.9"></a-box>
    </a-scene>

    <script>
      const scene  = document.getElementById('scene');
      const model  = document.getElementById('model');
      const sanity = document.getElementById('sanity');

      // Headset-friendly renderer defaults
      scene.addEventListener('loaded', () => {
        const r = scene.renderer;
        if (!r) return;
        r.toneMapping = THREE.ACESFilmicToneMapping;
        r.toneMappingExposure = 1.7;
        // Clamp pixel ratio for Quest-class devices
        const ua = navigator.userAgent;
        const isQuest = /Quest|Oculus/i.test(ua);
        r.setPixelRatio(isQuest ? 1.0 : Math.min(window.devicePixelRatio || 1, 1.5));
      });

      // Center/scale/drop model, then hide sanity box
      model.addEventListener('model-loaded', () => {
        const obj = model.getObject3D('mesh');
        if (!obj) return;

        const box = new THREE.Box3().setFromObject(obj);
        const size = new THREE.Vector3(); box.getSize(size);
        const center = new THREE.Vector3(); box.getCenter(center);
        obj.position.sub(center);

        // Scale to ~12 m largest dimension only if wildly off
        const maxDim = Math.max(size.x, size.y, size.z) || 1;
        const s = 12 / maxDim;
        if (s < 0.25 || s > 4) model.setAttribute('scale', `${s} ${s} ${s}`);

        // Drop to floor y=0
        const box2 = new THREE.Box3().setFromObject(obj);
        obj.position.y -= box2.min.y;

        sanity.setAttribute('visible', 'false');
        console.log('Model loaded.');
      });

      model.addEventListener('model-error', (e) => {
        console.error('Model load error:', e.detail?.src, e.detail?.error);
        sanity.setAttribute('visible','true');
      });
    </script>
  </body>
</html>
