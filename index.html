<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Store Walkthrough — refined + gradient sky</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- A-Frame -->
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-extras@7.7.0/dist/aframe-extras.min.js"></script>
    <!-- Gradient sky shader -->
    <script src="https://unpkg.com/aframe-gradient-sky@1.0.4/dist/gradientsky.min.js"></script>
    <style>html,body{margin:0;height:100%;background:#2f3033}</style>
  </head>
  <body>
    <a-scene id="scene"
      renderer="antialias:true; physicallyCorrectLights:true; colorManagement:true; shadowMap.enabled:true; shadowMap.type:pcfsoft">

      <!-- Assets: update path if you’re using the compressed file -->
      <a-assets timeout="60000">
        <a-asset-item id="room" src="https://ykkuinkyvupwu9iy.public.blob.vercel-storage.com/se3.glb"></a-asset-item>
      </a-assets>

      <!-- Soft gradient sky dome (very cheap, nice lift) -->
      <a-sky material="shader: gradient; topColor: #6c717b; bottomColor: #c7cdd6"></a-sky>

      <!-- Lighting (subtle but brighter): ambient + key + gentle fill -->
      <a-entity light="type: ambient; intensity: 0.9; color: #ffffff"></a-entity>
      <a-entity id="sun"
                light="type: directional; intensity: 1.55; castShadow: true"
                position="12 14 8"></a-entity>
      <a-entity light="type: directional; intensity: 0.6; color:#cfd6ff"
                position="-8 10 -6"></a-entity>

      <!-- Light, neutral floor that receives shadows -->
      <a-plane rotation="-90 0 0" width="600" height="600"
               material="color:#b5b9c2; metalness:0.15; roughness:0.7"
               shadow="receive:true"></a-plane>

      <!-- Model -->
      <a-entity id="model" gltf-model="#room" shadow="cast:true; receive:true"></a-entity>

      <!-- Camera rig (WASD + thumbstick). Start at -7.5 1.6 10 -->
      <a-entity id="rig" position="-7.5 1.6 -2.5" rotation="0 180 0"
      movement-controls
      kinematic-body="radius:0.3; height:1.6; stepHeight:0.2">
<a-entity camera look-controls wasd-controls></a-entity>
</a-entity>

      <!-- Safety cube (hidden once model is ready) -->
      <a-box id="sanity" position="-7.5 1.2 8"
             material="color:#ff6600; emissive:#ff6600; emissiveIntensity:0.8"></a-box>
    </a-scene>

    <script>
      const scene  = document.getElementById('scene');
      const model  = document.getElementById('model');
      const sanity = document.getElementById('sanity');

      // Subtle global brightness + headset-friendly DPR
      scene.addEventListener('loaded', () => {
        const r = scene.renderer;
        if (!r) return;
        r.toneMapping = THREE.ACESFilmicToneMapping;
        r.toneMappingExposure = 1.85;   // nudge 1.75–2.0 to taste
        const isQuest = /Quest|Oculus/i.test(navigator.userAgent);
        r.setPixelRatio(isQuest ? 1.0 : Math.min(window.devicePixelRatio||1, 1.5));
      });

      // Center, scale, drop to floor, then hide the safety cube
      model.addEventListener('model-loaded', () => {
        const obj = model.getObject3D('mesh');
        if (!obj) return;

        const box = new THREE.Box3().setFromObject(obj);
        const size = new THREE.Vector3(); box.getSize(size);
        const center = new THREE.Vector3(); box.getCenter(center);
        obj.position.sub(center);

        // Normalize scale to ~12 m only if wildly off
        const maxDim = Math.max(size.x, size.y, size.z) || 1;
        const s = 12 / maxDim;
        if (s < 0.25 || s > 4) model.setAttribute('scale', `${s} ${s} ${s}`);

        // Sit on floor
        const box2 = new THREE.Box3().setFromObject(obj);
        obj.position.y -= box2.min.y;

        // Enable shadows without overdoing it
        obj.traverse(n => { if (n.isMesh){ n.castShadow=true; n.receiveShadow=true; } });

        // Slightly softer, higher-res shadow map
        const sun = document.getElementById('sun').getObject3D('light');
        if (sun && sun.shadow){
          sun.shadow.mapSize.set(2048, 2048);
          sun.shadow.radius = 2.0;
          sun.shadow.camera.near = 0.1;
          sun.shadow.camera.far  = 120;
        }

        sanity.setAttribute('visible','false');
        console.log('Model centered, grounded, and lit.');
      });

      model.addEventListener('model-error', e => {
        console.error('Model load error:', e.detail?.src, e.detail?.error);
        sanity.setAttribute('visible','true');
      });
    </script>
  </body>
</html>
